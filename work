import json
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.keys import Keys
import time

with open('config.json', 'r', encoding='utf-8') as config_file:
    config = json.load(config_file)

user = config['user']
password = config['password']
text = config['text']

with open('person_list.txt', 'r', encoding='utf-8') as person_file:
    person_list = [line.strip() for line in person_file.readlines()]

# user = "george_spamowich12"
# password = "11!Admin"
# text = (
#     "Добрий день!\n\n"
#     "Мене звати Богдан, і я представляю ліцензійне казино України.\n\n"
#     "Ми пропонуємо вам співпрацю та надаємо : 60$ за одного ліда !\n\n"
#     "Лід – це користувач, який реєструється та вносить мінімальний депозит.\n\n"
#     "Надсилайте вашу статистику та обговоримо детальніше."
# )
# person_list = [
#     "gr1bson",
# ]

def start_selenium():
    PATH = "C:\\drivers\\chromedriver.exe"
    service = Service(executable_path=PATH)
    chrome_options = Options()
    chrome_options.add_argument("--disable-notifications")
    chrome_options.add_argument("--lang=en_US")

    driver = webdriver.Chrome(service=service, options=chrome_options)
    driver.get("https://www.instagram.com")
    driver.implicitly_wait(10)

    # Пропуск кукі
    pechenki_xpath = "//button[contains(@class, '_a9-- _ap36 _a9_0') and text()='Allow all cookies']"
    WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.XPATH, pechenki_xpath))
    )
    pechenki_button = driver.find_element(By.XPATH, pechenki_xpath)
    pechenki_button.click()

    driver.implicitly_wait(10)

    # Логування
    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.NAME, "username"))
    )
    user_input = driver.find_element(By.NAME, "username")
    user_input.send_keys(user)

    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.NAME, "password"))
    )
    pass_input = driver.find_element(By.NAME, "password")
    pass_input.send_keys(password)

    login_xpath = "//button[contains(@class, '_acan') and div[text()='Log in']]"
    WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.XPATH, login_xpath))
    )
    login_button = driver.find_element(By.XPATH, login_xpath)
    login_button.click()

    # Нот нау вікно
    not_now_xpath = "//div[contains(@class, 'x1i10hfl') and text()='Not now']"
    WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.XPATH, not_now_xpath))
    )
    not_now_button = driver.find_element(By.XPATH, not_now_xpath)
    not_now_button.click()

    return driver  

def send_message(driver, person, message):
    # Перехід до Direct messaging
    msg_sec_xpath = "//a[contains(@aria-label, 'Direct messaging')]"
    WebDriverWait(driver, 25).until(
        EC.element_to_be_clickable((By.XPATH, msg_sec_xpath))
    )
    msg_sec = driver.find_element(By.XPATH, msg_sec_xpath)
    msg_sec.click()

    # Процес вписування ніку 
    send_button_xpath = "//div[@role='button' and contains(text(), 'Send message')]"
    WebDriverWait(driver, 25).until(
        EC.element_to_be_clickable((By.XPATH, send_button_xpath))
    )
    send_button = driver.find_element(By.XPATH, send_button_xpath)
    send_button.click()

    WebDriverWait(driver, 10).until(
        EC.presence_of_element_located((By.NAME, "queryBox"))
    )
    search_input = driver.find_element(By.NAME, "queryBox")
    search_input.send_keys(person)

    # time.sleep(5)  # пауза перед вибором персони 

    checkbox_xpath = "//input[@aria-label='Radio selection']"
    WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.XPATH, checkbox_xpath))
    )
    checkbox = driver.find_element(By.XPATH, checkbox_xpath)
    checkbox.click()

    chat_xpath = "//div[contains(@class, 'x1i10hfl') and contains(text(), 'Chat')]"
    WebDriverWait(driver, 20).until(
        EC.element_to_be_clickable((By.XPATH, chat_xpath))
    )
    chat_button = driver.find_element(By.XPATH, chat_xpath)
    chat_button.click()

    # ввод текста
    message_box = WebDriverWait(driver, 25).until(
        EC.element_to_be_clickable((By.XPATH, "//div[@aria-placeholder='Message...']"))
    )
    message_box.click()

    for line in message.split('\n'):
        message_box.send_keys(line)
        message_box.send_keys(Keys.SHIFT + Keys.ENTER)
    
    message_box.send_keys(Keys.ENTER)

    time.sleep(5)

# Основной процесс
driver = start_selenium()

for person in person_list:
    send_message(driver, person, text)
    time.sleep(10)

driver.quit()

# bot.polling(none_stop=True)